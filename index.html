<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <style>
        #screen {
            background-color: #5f9ea07e;
            border: 1px solid rgba(105, 90, 205, 0.574);
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            image-rendering: -moz-crisp-edges;
            width: 400px;
        }

        #label {
            font-size: x-large;
            font-weight: bold;
            color: brown;
            width: 100%;
            text-align: center;
        }
    </style>
</head>

<body>
    <div class="container text-center">
        <br>
        <div class="row mb-3">
            <label class="col-4 col-form-label">Tamanho:</label>
            <div class="col-3">
                <input type="number" max="100" class="form-control form-control-sm" id="inputWidth">
            </div>
            <label for="inputPassword" class="col-2 col-form-label">X</label>
            <div class="col-3">
                <input type="number" max="100" class="form-control form-control-sm" id="inputHeight">
            </div>
        </div>
        <div class="row justify-content-md-center">
            <div class="col">
                <canvas id="screen"></canvas>
                <p id="label"></p>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
        crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
    <script type="text/javascript">

        const currentPlayerIndex = 0

        function createGame(canvasSize) {
            // objeto que armazena os jogadores e itens
            const state = {
                players: [
                    { name: 'p_1', position: { x: 1, y: 2 } },
                    { name: 'p_2', position: { x: 9, y: 9 } },
                ],
                fruits: [
                    { position: { x: 5, y: 5 } }
                ],
                canvasSize: {
                    width: canvasSize !== undefined ? canvasSize.width : 10,
                    height: canvasSize !== undefined ? canvasSize.height : 10
                }
            }

            const observers = []

            // add a observer
            function subscribe(observerFunction) {
                observers.push(observerFunction)
            }

            // notify a observer
            function notify(command) {
                for (const observerFunction of observers) {
                    observerFunction(command)
                }
            }

            function updateCanvasSize(canvasSize) {
                canvasSize.width > 100 ? state.canvasSize.width = 100 : state.canvasSize.width = canvasSize.width
                canvasSize.height > 100 ? state.canvasSize.height = 100 : state.canvasSize.height = canvasSize.height
                notify(state)
            }

            function getCanvasSize() {
                return state.canvasSize
            }

            // metodo que atualiza a posicao de player
            function movePlayer(command) {
                const keyPressed = command.keyPressed
                const canvasSize = command.canvasSize
                const player = state.players[command.playerId]

                // debug
                console.log(keyPressed)

                const acceptedMoves = {
                    ArrowUp(player) {
                        player.position.y - 1 >= 0 ? player.position.y -= 1 : ''
                    },
                    ArrowRight(player) {
                        player.position.x + 1 < canvasSize.width ? player.position.x += 1 : ''
                    },
                    ArrowDown(player) {
                        player.position.y + 1 < canvasSize.height ? player.position.y += 1 : ''
                    },
                    ArrowLeft(player) {
                        player.position.x - 1 >= 0 ? player.position.x -= 1 : ''
                    },
                    Enter() { }
                }

                const moveFunction = acceptedMoves[keyPressed]
                moveFunction(player)
                notify(state)
            }

            // retorna os artefatos
            return {
                movePlayer,
                subscribe,
                updateCanvasSize,
                getCanvasSize
            }
        }

        function createKeyboradListener() {
            // objeto que armazena os observers
            const state = {
                observers: []
            }

            // add a observer
            function subscribe(observerFunction) {
                state.observers.push(observerFunction)
            }

            // notify a observer
            function notify(command) {
                for (const observerFunction of state.observers) {
                    observerFunction(command)
                }
            }

            // add um listener
            document.addEventListener('keydown', handleKeyDown)

            // metodo que captura o input e notifica
            function handleKeyDown(event) {
                const keyPressed = event.key

                const command = {
                    playerId: currentPlayerIndex,
                    keyPressed,
                    canvasSize: canvasSize
                }

                notify(command)
            }

            return { subscribe }
        }

        function createScreen(canvasId) {
            const state = {
                screen: document.getElementById(canvasId),
                label: document.getElementById('label')
            }

            function updateSize(canvasSize) {
                state.screen.setAttribute('width', canvasSize.width)
                state.screen.setAttribute('height', canvasSize.height)
            }

            function getContext() {
                return state.screen.getContext('2d')
            }

            function writeLabel(text) {
                state.label.textContent = text
            }

            function renderScreen(gameState) {
                updateSize(gameState.canvasSize)
                writeLabel('')
                context = getContext()
                context.clearRect(0, 0, gameState.canvasSize.width, gameState.canvasSize.height)

                gameState.players.forEach(player => {
                    context.fillStyle = 'yellow'
                    context.fillRect(player.position.x, player.position.y, 1, 1)
                })
                gameState.fruits.forEach(fruit => {
                    context.fillStyle = 'green'
                    context.fillRect(fruit.position.x, fruit.position.y, 1, 1)
                })
                // requestAnimationFrame(renderScreen)
            }

            return { renderScreen, writeLabel }
        }

        const screen = createScreen('screen')
        screen.writeLabel('Enter to Start...')

        const game = createGame()
        game.subscribe(screen.renderScreen)

        const keyboradListener = createKeyboradListener()
        keyboradListener.subscribe(game.movePlayer)

        document.addEventListener('DOMContentLoaded', function () {
            canvasSize = game.getCanvasSize()
            $("#inputWidth").val(canvasSize.width)
            $("#inputHeight").val(canvasSize.height)
        })

        $("#inputWidth").change(function () {
            canvasSize = {
                width: $(this).val(),
                height: $("#inputHeight").val()
            }
            game.updateCanvasSize(canvasSize)
        })

        $("#inputHeight").change(function () {
            canvasSize = {
                width: $("#inputWidth").val(),
                height: $(this).val()
            }
            game.updateCanvasSize(canvasSize)
        })
    </script>
</body>

</html>